%%!TEX root = ./UserManual.tex
\chapter{Simulator}
\label{chap:simulator}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Workspace
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Workspace}

By default, \texttt{Stride} is installed in \texttt{./target/installed/} inside de project directory. This can be modified by setting the \texttt{CMAKE\_INSTALL\_PREFIX} on the CMake command line (see the \texttt{INSTALL.txt} file in the prject root directory) or by using the CMakeLocalConfig.txt file (example file can be found  in \texttt{./src/main/resources/make}).

Compilation and installation of the software creates the following files and directories:
\begin{compactitem}
%
	\item Binaries in directory \texttt{<install\_dir>/bin}
      		\begin{compactitem}
        			\item $stride$: executable.
        			\item $gtester$: regression tests for the sequential code.
               	 \item $gengeopop$: generates the population and geographical grid.
        			\item $wrapper\_sim.py$: Python simulation wrapper
        	\end{compactitem}
%
    \item Configuration files (xml and json) in directory \texttt{<install\_dir>/config}
      	\begin{compactitem}
			\item $run\_default.xml$: default configuration file for Stride to perform a Nassau simulation.
        		\item $run\_generate\_default.xml$: default configuration file for Stride to first generate a population and geographical grid and then perform a Nassau Simulation.
       		\item $run\_import\_default.xml$: default configuration file for Stride to first import a population and geographical grid and then perform a Nassau Simulation.
        		\item $run\_miami\_weekend.xml$: configuration file for Stride to perform Miami simulations with uniform social contact rates in the community clusters.
			\item $wrapper\_miami.json$: default configuration file for the wrapper\_sim binary to perform Miami simulations with different attack rates.
        		\item \ldots
        \end{compactitem}
%        
    \item Data files (csv) in directory \texttt{<project\_dir>/data}
      	\begin{compactitem}
        		\item $belgium\_commuting$: Belgian commuting data for the active populations. The fraction of residents from ``city\_depart'' that are employed in ``city\_arrival''. Details are provided for all cities and for 13 major cities.
			\item $belgium\_population$: Relative Belgian population per city. Details are provided for all cities and for 13 major cities.
        	\item $flanders\_cities$: Cities and municipalities in Flanders with coordinates and population figures based on samples. These relative population figures are used for assigning residencies and domiciles based on a discrete probability distribution.
        	\item $flanders\_commuting$: Relative commuting information between cities and communities. Since this data is relative, the total number of commuters is a derived parameter, based on the fraction of the total population that is commuting.
			\item $contact\_matrix\_average$: Social contact rates, given the cluster type. Community clusters have average (week/weekend) rates.
			\item $contact\_matrix\_week$: Social contact rates, given the cluster type. Community clusters have week rates.
			\item $contact\_matrix\_week$: Social contact rates, given the cluster type. Primary Community cluster has weekend rates, Secondary Community has week rates.
			\item $disease\_xxx$: Disease characteristics (incubation and infectious period) for xxx.
			\item $holidays\_xxx$: Holiday characteristics for xxx.
			\item $pop\_xxx$: Synthetic population data extracted from the 2010 U.S. Synthetic Population Database (Version 1) from RTI International for xxx \cite{wheaton2014a,wheaton2014b}.
			\item $ref\_2011$: Reference data from EUROSTAT on the Belgian population of 2011. Population ages and household sizes.
			\item $ref\_fl2010\_xxx$: Reference data on social contacts for Belgium, 2011.
        \end{compactitem}
%
    \item Documentation files in directory \texttt{./target/installed/doc}
      	\begin{compactitem}
        			\item Reference manual
        			\item User manual
        \end{compactitem}
%
\end{compactitem}

The install directory is also the workspace for \texttt{Stride}. The \texttt{Stride} executable allows you to use a different output directory for each new calculation (see the next section).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Run
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Running the simulator}

From the workspace directory, the simulator can be started  using the command \mbox{``\texttt{./bin/stride}''}. Arguments can be passed to the simulator on the command line:
\begin{verbatim}
USAGE: 
 
   bin/stride  [-e <clean|dump|sim|geopop>] [-c <CONFIGURATION>] [-o
               <<NAME>=<VALUE>>] ...  [-i] [--stan <COUNT>] [--]
               [--version] [-h]
Where: 
 
   -e <clean|dump|sim|geopop>,  --exec <clean|dump|sim|geopop>
     Execute the corresponding function:  
         clean:  cleans configuration and writes it to a new file.  
         dump:   takes built-in configuration writes it to a file.  
         sim:    runs the simulator and is the default.  
         geopop: runs the geospatial synthetic population generator
     Defaults to --exec sim.
 
   -c <CONFIGURATION>,  --config <CONFIGURATION>
     Specifies the run configuration parameters. The format may be 
     either -c file=<file> or -c name=<name>. The first is the most
     used and may be shortened to -c <file>. The second refers to
     built-in configurations specified by their name.
     Defaults to -c file=run_default.xml
 
   -o <<NAME>=<VALUE>>,  --override <<NAME>=<VALUE>>  (accepted multiple
      times)
     Override configuration file parameters with values provided here.
 
   -i,  --installed
     Look for configuration file specified by the -c file=<file>  or -c
     <file> in the stride install directories
 
   --stan <COUNT>
     Stochastic Analysis (stan) will run <COUNT> simulations, each with
     a different seed for the random engine. Only applies in case of -e sim.
 
   --,  --ignore_rest
     Ignores the rest of the labeled arguments following this flag.
 
   --version
     Displays version information and exits.
 
   -h,  --help
     Displays usage information and exits.
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% genpop
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Generating a population and geographical grid}

 The generation of a population and geographical grid (sometimes called GeoGrid) can be started from the workspace directory, with the command \mbox{``\texttt{./bin/genpop}''}. The following options are available:
\begin{verbatim}
bin/genpop  [--loglevel <trace|debug|info|warn|error|critical|off>]
                  [--output <OUTPUT FILE>] [--seed <SEED>]
                  [--populationSize <POPULATION SIZE>] [--fracActive
                  <FRACTION OF PEOPLE ACTIVE>] [--frac1826students
                  <FRACTION 18-26 STUDENTS>] [--fracStudentCommuting
                  <FRACTION OF STUDENTS COMMUTING>] [--fracActiveCommuting
                  <FRACTION OF ACTIVE PEOPLE COMMUTING>] [--household
                  <HOUSEHOLDS FILE>] [--commuting <COMMUTING FILE>]
                  [--cities <CITIES FILE>] [--] [--version] [-h]
 
Where: 
 
   --loglevel <trace|debug|info|warn|error|critical|off>
     Log level. Defaults to --loglevel info.
 
   --output <OUTPUT FILE>
     Output file with synthetic population in protobuf format.             
     Defaults to --output gengeopop.proto.
 
   --seed <SEED>
     The seed sequence for the random engine. Defaults to {1,2,3,4}.
 
   --populationSize <POPULATION SIZE>
     Populations size. Defaults to --populationSize 600000.
 
   --fracActive <FRACTION OF PEOPLE ACTIVE>
     Fraction of people that are active. Defaults to --fracActive 0.75.
 
   --frac1826students <FRACTION 18-26 STUDENTS>
     Fraction of 18-26 year old persons that are students.                 
     Defaults to --frac1826students 0.5.
 
   --fracStudentCommuting <FRACTION OF STUDENTS COMMUTING>
     Fraction of students that commute.                                    
     Defaults to --fracStudentCommuting 0.5.
 
   --fracActiveCommuting <FRACTION OF ACTIVE PEOPLE COMMUTING>
     Fraction of active persons that commute.                              
     Defaults to --fracActiveCommuting 0.5.
 
   --household <HOUSEHOLDS FILE>
     Input file with reference set of households in csv format.            
     Defaults to --household households_flanders.csv.
 
   --commuting <COMMUTING FILE>
     Input file with data on commuting in csv format.                      
     Defaults to --commuting flanders_commuting.csv.
 
   --cities <CITIES FILE>
     Input file with data on cities in csv format.                         
     Defaults to --cities flanders_cities.csv.
 
   --,  --ignore_rest
     Ignores the rest of the labeled arguments following this flag.
 
   --version
     Displays version information and exits.
 
   -h,  --help
     Displays usage information and exits.
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Wrapper
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Python Wrapper}
A Python wrapper is provided to perform multiple runs with the C++ executable.
The wrapper is designed to be used with .json configuration files and examples are provided with the source code.
For example: \\ \\
\centerline{\texttt{./bin/wrapper\_sim --config ./config/wrapper\_default.json}} \\ \\
will start the simulator with each configuration in the file.
It is important to note the input notation: values given inside brackets can be extended (e.g., ``rng\_seeds''=[1,2,3]) but single values can only be replaced by one other value (e.g., ``days'': 100).


